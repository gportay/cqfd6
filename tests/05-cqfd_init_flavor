#!/usr/bin/env bash
#
# validate the behavior of --init option with flavors

set -o pipefail

. "$(dirname "$0")/jtest.inc" "$1"
cqfd="$TDIR/.cqfd/cqfd"
flavor="foo"

cd "$TDIR/" || exit 1

################################################################################
# 'cqfd --reinit' with different flavor makes a different container
################################################################################
cp -f .cqfdrc .cqfdrc.orig
sed -i -e "s/\[foo\]/[foo]\ndistro='centos'/" .cqfdrc

jtest_prepare "cqfd --reinit using '$flavor' flavor"
if "$cqfd" -b "$flavor" --reinit grep '^NAME=' /etc/os-release | grep -q 'NAME="CentOS Linux"'; then
	jtest_result pass
else
	jtest_result fail
fi
# restore initial .cqfdrc
mv -f .cqfdrc.orig .cqfdrc

################################################################################
# 'cqfd --reinit' with invalid flavor should fail
################################################################################
flavorPart="${flavor:0:2}"
jtest_prepare "cqfd --reinit using part of '$flavor' flavor should fail"
if ! "$cqfd" -b "$flavorPart" --reinit; then
	jtest_result pass
else
	jtest_result fail
fi

################################################################################
# 'cqfd --reinit' without flavor generates our regular container
################################################################################
jtest_prepare "cqfd --reinit without flavor"
if "$cqfd" --reinit grep '^NAME=' /etc/os-release | grep -q 'NAME="Ubuntu"'; then
	jtest_result pass
else
	jtest_result fail
fi
