#!/usr/bin/env bash
#
# validate the .cqfdrc syntax

set -o pipefail

. "$(dirname "$0")/jtest.inc" "$1"

cd "$TDIR/" || exit 1

cp -f .cqfdrc .cqfdrc.orig

echo -n "" >.cqfdrc

jtest_prepare "run cqfd with no project section in cqfdrc file should fail"
if cqfd 2>&1 | grep "^cqfd: fatal: .cqfdrc: Missing project section!$"; \
   test "${PIPESTATUS[0]}" -eq 1 -a "${PIPESTATUS[1]}" -eq 0; then
	jtest_result pass
else
	jtest_result fail
fi

echo "[project]" >>.cqfdrc

jtest_prepare "run cqfd with no name property set in project section in cqfdrc file should fail"
if cqfd 2>&1 | grep "^cqfd: fatal: .cqfdrc: Missing project.org or project.name properties!$"; \
   test "${PIPESTATUS[0]}" -eq 1 -a "${PIPESTATUS[1]}" -eq 0; then
	jtest_result pass
else
	jtest_result fail
fi

echo "name=test" >>.cqfdrc

jtest_prepare "run cqfd with cqfdrc with no org property set in project section in cqfdrc file should fail"
if cqfd 2>&1 | grep "^cqfd: fatal: .cqfdrc: Missing project.org or project.name properties!$"; \
   test "${PIPESTATUS[0]}" -eq 1 -a "${PIPESTATUS[1]}" -eq 0; then
	jtest_result pass
else
	jtest_result fail
fi

echo "org=cqfd" >>.cqfdrc

jtest_prepare "run cqfd with no build section in cqfdrc file should fail"
if cqfd 2>&1 | grep "^cqfd: fatal: .cqfdrc: Missing build section!$"; \
   test "${PIPESTATUS[0]}" -eq 1 -a "${PIPESTATUS[1]}" -eq 0; then
	jtest_result pass
else
	jtest_result fail
fi

echo "[build]" >>.cqfdrc

jtest_prepare "run cqfd with no command property set in build section in cqfdrc file should fail"
if cqfd 2>&1 | grep "^cqfd: fatal: .cqfdrc: Missing or empty build.command property!$"; \
   test "${PIPESTATUS[0]}" -eq 1 -a "${PIPESTATUS[1]}" -eq 0; then
	jtest_result pass
else
	jtest_result fail
fi

jtest_prepare "run cqfd with required properties set in project and build sections in cqfdrc file should pass"
if cqfd init && cqfd run true; then
	jtest_result pass
else
	jtest_result fail
fi

jtest_prepare "run cqfd run -c with no command property set in build section in cqfdrc should pass"
if cqfd run -c true 2>&1 | grep "^cqfd: warning: .cqfdrc: Missing or empty build.command property!$"; \
   test "${PIPESTATUS[0]}" -eq 0 -a "${PIPESTATUS[1]}" -eq 0; then
	jtest_result pass
else
	jtest_result fail
fi

echo "command=true" >>.cqfdrc

jtest_prepare "run cqfd run with command property set in build section in cqfdrc should pass"
if cqfd run; then
	jtest_result pass
else
	jtest_result fail
fi

jtest_prepare "run cqfd run -c with command property set in build section in cqfdrc should pass"
if cqfd run -c true 2>&1 | grep "^cqfd: warning: .cqfdrc: Missing or empty build.command property!$"; \
   test "${PIPESTATUS[0]}" -eq 0 -a "${PIPESTATUS[1]}" -ne 0; then
	jtest_result pass
else
	jtest_result fail
fi

cp -f .cqfdrc.orig .cqfdrc
echo "foo	=bar" >>.cqfdrc

jtest_prepare "run cqfd run with tabulation before property assignment in cqfdrc file should pass"
if cqfd run true; then
	jtest_result pass
else
	jtest_result fail
fi

cp -f .cqfdrc.orig .cqfdrc
echo "foo=	bar" >>.cqfdrc

jtest_prepare "run cqfd run with tabulation after property assignment in cqfdrc file should pass"
if cqfd run true; then
	jtest_result pass
else
	jtest_result fail
fi

cp -f .cqfdrc.orig .cqfdrc
echo "foo =bar" >>.cqfdrc

jtest_prepare "run cqfd run with whitespace before property assignment in cqfdrc file should pass"
if cqfd run true; then
	jtest_result pass
else
	jtest_result fail
fi

cp -f .cqfdrc.orig .cqfdrc
echo "foo= bar" >>.cqfdrc

jtest_prepare "run cqfd run with whitespace after property assignment in cqfdrc file should pass"
if cqfd run true; then
	jtest_result pass
else
	jtest_result fail
fi

cp -f .cqfdrc.orig .cqfdrc
sed -i -e "/\[build\]/,/^$/s,^command=.*$,command='true; echo \"; works!\"'," .cqfdrc

jtest_prepare "cqfdrc does not strip semicolons in command"
if cqfd init && cqfd | grep "^; works!$" ; then
	jtest_result pass
else
	jtest_result fail
fi

cp -f .cqfdrc.orig .cqfdrc
sed -i -e "/\[build\]/,/^$/s,^command=.*$,command='true; echo \"# works!\"'," .cqfdrc

jtest_prepare "cqfdrc does not strip hash in command"
if cqfd init && cqfd | grep "^# works!$" ; then
	jtest_result pass
else
	jtest_result fail
fi

cp -f .cqfdrc.orig .cqfdrc
sed -i -e "/\[build\]/,/^$/s,^command=.*$,command=\"echo \\\\\\
	foo=bar \\\\\\
	baz=quux\"," .cqfdrc

jtest_prepare "cqfdrc with multiline should pass"
if cqfd | grep "^foo=bar baz=quux$"; then
	jtest_result pass
else
	jtest_result fail
fi

cp -f .cqfdrc.orig .cqfdrc
sed -i -e "/\[project\]/,/^$/s,^,; ," .cqfdrc

jtest_prepare "cqfdrc with ;-commented project section should fail"
if cqfd 2>&1 | grep "^cqfd: fatal: .cqfdrc: Missing project section!$"; \
   test "${PIPESTATUS[0]}" -eq 1 -a "${PIPESTATUS[1]}" -eq 0; then
	jtest_result pass
else
	jtest_result fail
fi

cp -f .cqfdrc.orig .cqfdrc
sed -i -e "/\[build\]/,/^$/s,^,# ," .cqfdrc

jtest_prepare "cqfdrc with #-commented build section should fail"
if cqfd 2>&1 | grep "^cqfd: fatal: .cqfdrc: Missing build section!$"; \
   test "${PIPESTATUS[0]}" -eq 1 -a "${PIPESTATUS[1]}" -eq 0; then
	jtest_result pass
else
	jtest_result fail
fi

cp -f .cqfdrc.orig .cqfdrc
sed -i -e "/[build]/,/^$/s,^command=.*$,command=\"make foo\"," .cqfdrc
echo "include /dev/null" >>.cqfdrc

jtest_prepare "cqfdrc with include empty file should pass"
if cqfd && test -e foo; then
	jtest_result pass
else
	jtest_result fail
fi
rm -f foo

cat <<EOF >bar.inc
[build]
command="make bar"
EOF
echo "include bar.inc" >>.cqfdrc

jtest_prepare "cqfdrc with include file should pass"
if cqfd && test -e bar; then
	jtest_result pass
else
	jtest_result fail
fi
rm -f bar

echo "include bar.inc" >>.cqfdrc

jtest_prepare "cqfdrc with duplicate include file should pass"
if cqfd && test -e bar; then
	jtest_result pass
else
	jtest_result fail
fi
rm -f bar

echo "include bar.inc" >>bar.inc

jtest_prepare "cqfdrc with recursive include file should fail"
if ! cqfd; then
	jtest_result pass
else
	jtest_result fail
fi

# cleanup
rm -f bar.inc

# restore initial .cqfdrc
mv -f .cqfdrc.orig .cqfdrc
