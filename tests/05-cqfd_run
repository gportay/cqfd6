#!/usr/bin/env bash
#
# validate the behavior of run command

. "$(dirname "$0")/jtest.inc" "$1"
test_file="a/cqfd_a.txt"

cd "$TDIR/" || exit 1

# Here we test cqfd run, which is also invoked without any argument

jtest_prepare "running \"cqfd\" with no argument makes it run"

# at the end of either test, $test_file is populated
# shellcheck disable=SC2181
if cqfd && grep -qw "^cqfd$" "$test_file"; then
	jtest_result pass
else
	jtest_log info "$test_file not present after test"
	jtest_result fail
	rm -f "$test_file"
fi

rm -f "$test_file"

jtest_prepare "running \"cqfd run\" makes it run"

# at the end of either test, $test_file is populated
# shellcheck disable=SC2181
if cqfd run && grep -qw "^cqfd$" "$test_file"; then
	jtest_result pass
else
	jtest_log info "$test_file not present after test"
	jtest_result fail
	rm -f "$test_file"
fi

rm -f "$test_file"

################################################################################
# If the Dockerfile changed and no init is done again, 'cqfd run' should fail
################################################################################
jtest_prepare "Modifying the Dockerfile should require running 'cqfd init' again"
dockerfile=.cqfd/docker/Dockerfile
echo "RUN echo $RANDOM" >>"$dockerfile"
if ! cqfd run; then
	jtest_result pass
else
	jtest_result fail
fi
# cleanup
make clean
# restore Dockerfile
sed -i '$d' "$dockerfile"
