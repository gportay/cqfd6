#!/usr/bin/env bash
#
# validate the sanitization of image name

set -o pipefail

. "$(dirname "$0")/jtest.inc" "$1"
cqfd="$TDIR/.cqfd/cqfd"
cqfd_docker="${CQFD_DOCKER:-docker}"

cd "$TDIR/" || exit 1

cp -f .cqfdrc .cqfdrc.orig

################################################################################
# 'cqfd init' creates image with invalid user name should pass
################################################################################
dockerfile_hash="$(sha256sum .cqfd/docker/Dockerfile | cut -b 1-7)"
image="cqfd_user_invalid_cqfd_test_docker"
if "$cqfd_docker" inspect "$image" &>/dev/null; then
	jtest_log info "$cqfd_docker registry contains image named: $image:$dockerfile_hash, removing..."
	"$cqfd_docker" rmi "$image:$dockerfile_hash"
fi

jtest_prepare "cqfd init creates image with invalid user name"
if USER="user@invalid" "$cqfd" init && \
   "$cqfd_docker" inspect "$image:$dockerfile_hash" &>/dev/null; then
	jtest_result pass
else
	jtest_result fail
fi
"$cqfd_docker" rmi "$image:$dockerfile_hash"

################################################################################
# 'cqfd init' creates image with invalid character in project.org should pass
################################################################################
jtest_prepare "cqfd init creates image with invalid character in project.org"
sed -e "s!^org=.*\$!org='savoirfairelinux@invalid'!" .cqfdrc.orig >.cqfdrc
if "$cqfd" init; then
	jtest_result pass
else
	jtest_result fail
fi

################################################################################
# 'cqfd init' creates image with invalid character in project.name should pass
################################################################################
jtest_prepare "cqfd init creates image with invalid character in project.name"
sed -e "s!^name=.*\$!name='test@invalid'!" .cqfdrc.orig >.cqfdrc
if "$cqfd" init; then
	jtest_result pass
else
	jtest_result fail
fi

################################################################################
# Restore initial .cqfdrc and Dockerfile
################################################################################
mv -f .cqfdrc.orig .cqfdrc
