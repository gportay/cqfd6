#!/usr/bin/env bash
#
# validate the behavior of run command with alternative config file and build flavors

. "$(dirname "$0")/jtest.inc" "$1"

cd "$TDIR/" || exit 1

extdir="external/dir"
flavor="foo"
mkdir -p "$extdir"
mv .cqfdrc "$extdir/mycqfdrc"

test_file="a/cqfd_a.txt"
jtest_prepare "run cqfd run without argument and with option -f should pass"
if cqfd -f "$extdir/mycqfdrc" run && [ -f "$test_file" ]; then
	jtest_result pass
else
	jtest_result fail
fi
# cleanup
rm -f "$test_file"

test_file="file.$RANDOM"
jtest_prepare "run cqfd run with argument and option -f should pass"
if cqfd -f "$extdir/mycqfdrc" run "touch $test_file" && [ -f "$test_file" ]; then
	jtest_result pass
else
	jtest_result fail
fi
# cleanup
rm -f "$test_file"

test_file="$flavor.$RANDOM"
jtest_prepare "run cqfd run with argument and options -f and -b should pass"
if cqfd -f "$extdir/mycqfdrc" -b "$flavor" run "touch $test_file" && [ -f "$test_file" ]; then
	jtest_result pass
else
	jtest_result fail
fi
# cleanup
rm -f "$test_file"

test_file="$flavor.$RANDOM"
jtest_prepare "run cqfd run with argument and options -b and -f should pass"
if cqfd -b "$flavor" -f "$extdir/mycqfdrc" run "touch $test_file" && [ -f "$test_file" ]; then
	jtest_result pass
else
	jtest_result fail
fi
# cleanup
rm -f "$test_file"

# restore initial .cqfdrc
mv -f "$extdir/mycqfdrc" .cqfdrc

# cleanup
make clean
rmdir -p "$extdir"
